<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
              x:Name="Root"
             xmlns:vm="clr-namespace:SchnapsSchuss.ViewModels"
             xmlns:entities="clr-namespace:SchnapsSchuss.Models.Entities"
             x:Class="SchnapsSchuss.Views.CashRegisterPage">

    <ContentPage.BindingContext>
        <vm:CashRegisterViewModel />
    </ContentPage.BindingContext>
    
    <ContentPage.Content>
        <ScrollView>
            <VerticalStackLayout Margin="20" Spacing="20">
                
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="20">
                    <!-- Back Button -->
                    <Button Command="{Binding CloseViewCommand}" Grid.Column="0" Text="Zurück" />
                    
                    <!-- Customer Name Label -->
                    <Label
                        Grid.Column="1"
                        Text="{Binding PersonLabel}"
                        HorizontalTextAlignment="Center"
                        Style="{StaticResource Headline}"
                        MaxLines="1"
                        LineBreakMode="TailTruncation" 
                    />
                </Grid>

                <!-- Main Part -->
                <Grid ColumnDefinitions="2*,6*,2*">

                    <!-- Left Column: Purchased Articles with border -->
                    <Border Grid.Column="0" Stroke="Gray" StrokeThickness="2" Padding="10" Margin="0,0,10,0">
                        <Grid RowDefinitions="Auto,*,Auto">
                            <!-- Header Row -->
                            <Grid ColumnDefinitions="*,50,40" ColumnSpacing="12" Grid.Row="0">
                                <Label Text="Name"  Grid.Column="0" FontAttributes="Bold" />
                                <Label Text="Menge" Grid.Column="1" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Text="Preis" Grid.Column="2" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <!-- Bottom border for header -->
                                <BoxView HeightRequest="2" BackgroundColor="Gray" Grid.ColumnSpan="3" VerticalOptions="End"/>
                            </Grid>

                            <!-- Invoice Items Collection -->
                            <CollectionView ItemsSource="{Binding InvoiceItems}" Grid.Row="1">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="15" />
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*,40,40" ColumnSpacing="12">
                                            <Label Text="{Binding Article.Name}" Grid.Column="0"/>
                                            <Label Text="{Binding Amount}" Grid.Column="1" HorizontalTextAlignment="End" />
                                            <Label Text="{Binding TotalPrice}" Grid.Column="2" HorizontalTextAlignment="End" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                            <!-- Total Row pinned at bottom with top border -->
                            <Grid ColumnDefinitions="*,Auto" Grid.Row="2" Padding="0,10,0,0">
                                <BoxView HeightRequest="2" BackgroundColor="Gray" Grid.ColumnSpan="2" VerticalOptions="Start"/>
                                <Label Text="Gesamt:" FontAttributes="Bold" Grid.Column="0" Margin="0,5,0,0"/>
                                <Label Text="{Binding InvoiceTotal}" FontAttributes="Bold" Grid.Column="1" Margin="0,5,0,0"/>
                            </Grid>
                        </Grid>
                    </Border>

                    <!-- Middle Column: Article Buttons with gaps -->
                    <CollectionView Grid.Column="1" ItemsSource="{Binding FilteredArticles}">
                        <CollectionView.ItemsLayout>
                            <!-- span = number of buttons per row -->
                            <GridItemsLayout Orientation="Vertical" Span="3" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <!-- Button fills its cell with margin for spacing -->
                                <Button Text="{Binding Name}" 
                                    Margin="5"
                                    HorizontalOptions="Fill"
                                    VerticalOptions="Fill"
                                    Command="{Binding BindingContext.AddArticleCommand, Source={x:Reference Root}}"
                                    IsEnabled="{Binding Stock}"
                                    CommandParameter="{Binding .}" />
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Right Column: Categories -->
                    <VerticalStackLayout Grid.Column="2" Spacing="10" HorizontalOptions="End" VerticalOptions="Start">
                        <Button Text="Getränke" HeightRequest="100" WidthRequest="120"
                Command="{Binding FilterArticlesCommand}" 
                CommandParameter="{x:Static entities:ArticleType.DRINK}" />
                        <Button Text="Gerichte" HeightRequest="100" WidthRequest="120"
                Command="{Binding FilterArticlesCommand}" 
                CommandParameter="{x:Static entities:ArticleType.FOOD}" />
                        <Button Text="Munition" HeightRequest="100" WidthRequest="120"
                Command="{Binding FilterArticlesCommand}" 
                CommandParameter="{x:Static entities:ArticleType.MUNITION}" />
                        <Button Text="Disziplin" HeightRequest="100" WidthRequest="120"
                Command="{Binding FilterArticlesCommand}" 
                CommandParameter="{x:Static entities:ArticleType.DISCIPLINE}" />
                        <Button Text="Sonstiges" HeightRequest="100" WidthRequest="120"
                Command="{Binding FilterArticlesCommand}" 
                CommandParameter="{x:Static entities:ArticleType.OTHER}" />
                    </VerticalStackLayout>
                </Grid>
                <Button Text="Bezahlen" Command="{Binding PayInvoiceCommand}" />
            </VerticalStackLayout>
        </ScrollView>
    </ContentPage.Content>
</ContentPage>